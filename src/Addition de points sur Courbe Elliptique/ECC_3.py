import numpy as np
import matplotlib.pyplot as plt
import random
import warnings
from decimal import Decimal, getcontext

warnings.filterwarnings("ignore", category=RuntimeWarning)

# Curve params
a = -1
b = 1
q = 31
C = (a, b, q)

# Changed float Decimal precision to 50 places
getcontext().prec = 50


def random_genesis(x_min, x_max, curve):
    a = curve[0]
    b = curve[1]

    genesis_x = random.randint(x_min * 100, x_max * 100) / 100
    genesis_y = genesis_x ** 3 + genesis_x * a + b
    max_tries = 100
    i = 0

    while genesis_y < 0 and i < max_tries:
        genesis_x = random.randrange(x_min * 100, x_max * 100) / 100
        genesis_y = genesis_x ** 3 + genesis_x * a + b
        i += 1

    if np.isnan(genesis_y):
        raise TypeError

    return genesis_x, np.sqrt(genesis_y)


def add(P1, P2, curve_param):

    a = Decimal(curve_param[0])
    q = Decimal(curve_param[2])
    I = float('inf')

    x1 = Decimal(P1[0])
    y1 = Decimal(P1[1])
    x2 = Decimal(P2[0])
    y2 = Decimal(P2[1])

    if x1 != I and x2 != I:
        if P1 == P2:
            m = Decimal(Decimal(1) / Decimal(2) * (3 * x1 ** 2 + a) / y1)

        else:
            m = Decimal((y2 - y1) / (x2 - x1))

        x3 = -x1 - x2 + m ** 2
        y3 = -y1 + m * (x1 - x3)

    elif x1 == I and x2 != I:
        x3, y3 = x2, y2
    elif x1 != I and x2 == I:
        x3, y3 = x1, y1
    else:  # x1 == I and x2 == I:
        x3, y3 = I, I

    if is_point_on_curve((x3, y3), curve_param):
        return x3, y3

    print('Point ', x3, y3, 'not on curve!')
    return x3, y3


def compute_points(g, n, C, isDisplay):  # Computes n points of C, starting with the genesis(g) and returns them
    # in a list, ordered.
    print('')
    print('Genesis : ', g)

    points = [g]
    previous_point = g

    for i in range(1, n + 1):
        tmp_point = add(g, previous_point, C)
        points.append(tmp_point)
        previous_point = tmp_point

        if isDisplay:  # DEBUGGING
            print('')
            print('Point', i, ':', previous_point)

    return points


def is_point_on_curve(point, curve):
    x0 = point[0]
    y0 = point[1]
    a = curve[0]
    b = curve[1]

    rounding = 6

    y_test = np.sqrt(x0 ** 3 + a * x0 + b)
    y_test = round(y_test, rounding)

    y0 = round(y0, rounding)

    #  print(y_test, abs(y0)) #  DEBUGGING

    if y_test == abs(y0):
        return True

    return False


# First point
n = 1000  # random.randint(100000, 1000000)
genesis = random_genesis(-5, 5, C)
values = compute_points(genesis, n, C, False)
x_pubkey = values[-1][0]
y_pubkey = values[-1][1]

Curve_display = True
Pub_key_display = False

print('')
print("Public Key: ", )
print("x: ", x_pubkey)
print("y: ", y_pubkey)
print('')
print("Private Key: ", n)


if Curve_display:
    x1, y1 = zip(*values)
    plt.scatter(x1, y1, s=25)
    plt.scatter(x_pubkey, y_pubkey, s=50, color='hotpink')

    x = np.arange(-50, 50, 0.001)
    y = np.sqrt(x ** 3 + a * x + b)
    plt.plot(x, y, 'black')
    plt.plot(x, -y, 'black')

    # plot
    plt.xlim(-20, 50)
    plt.ylim(-100, 100)
    plt.grid()
    plt.show()

if Pub_key_display:
    plt.scatter(x_pubkey, y_pubkey, color = 'hotpink')

    x = np.arange(-50, 50, 0.001)
    y = np.sqrt(x ** 3 + a * x + b)
    plt.plot(x, y, 'black')
    plt.plot(x, -y, 'black')

    # plot
    plt.xlim(-20, 50)
    plt.ylim(-100, 100)
    plt.grid()
    plt.show()
